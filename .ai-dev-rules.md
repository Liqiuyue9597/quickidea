# QuickIdea 项目开发规范

## 📋 代码提交前必做检查清单

### 1. 自动化检查（CRITICAL）

每次修改代码后，**必须**运行构建测试：

```bash
# 清理并构建
xcodebuild -scheme QuickIdea -sdk iphonesimulator \
  -destination 'platform=iOS Simulator,name=iPhone 15' \
  clean build 2>&1 | grep -E "(error:|warning:|BUILD)"
```

**通过标准**:
- ✅ `BUILD SUCCEEDED`
- ❌ 任何 `error:` 必须修复

### 2. 代码修改检查清单

在每次 Edit 操作后：

- [ ] 检查是否有重复代码残留
- [ ] 验证所有大括号配对正确
- [ ] 确认函数签名匹配
- [ ] 检查类型兼容性
- [ ] 验证可选值处理

### 3. Swift 常见陷阱

#### SwiftUI 视图返回类型
```swift
// ❌ 错误 - 类型不匹配
var myView: some View {
    if condition {
        Text("A")  // Text
    } else {
        Image("B") // Image - 不同类型！
    }
}

// ✅ 正确 - 使用 @ViewBuilder
@ViewBuilder
var myView: some View {
    if condition {
        Text("A")
    } else {
        Image("B")
    }
}
```

#### SwiftData 模型迁移
```swift
// 数据模型改变时，必须处理迁移
do {
    modelContainer = try ModelContainer(...)
} catch {
    // 自动清理旧数据
    try? FileManager.default.removeItem(at: url)
    modelContainer = try ModelContainer(...)
}
```

#### 未使用的变量
```swift
// ❌ 警告
if let unused = optional { }

// ✅ 修复
if optional != nil { }
// 或
if let value = optional {
    print(value) // 使用它
}
```

---

## 🔄 标准开发流程

### 阶段 1: 规划
1. 理解用户需求
2. 列出要修改的文件
3. 识别潜在的依赖关系

### 阶段 2: 实现
1. 修改代码
2. **立即构建测试**
3. 修复所有错误
4. 再次构建确认

### 阶段 3: Review（新增！）
每次代码修改完成后：

```bash
# 1. 构建测试
xcodebuild -scheme QuickIdea ... build 2>&1 | tail -20

# 2. 检查错误
grep -i "error:"

# 3. 检查警告
grep -i "warning:"
```

### 阶段 4: 提交前确认

**关键原则**:
- ⚠️ **永远不要自动提交** - 等用户说"提交吧"
- 🗑️ **临时文件不入库** - `*-demo.html`, `*_DEMO.md`, `test-*.*` 等
- ✅ **用户确认优先** - 功能完成 ≠ 可以提交

---

## 🎯 质量标准

### 代码提交条件

只有满足以下所有条件才能认为"完成"：

1. ✅ 构建成功（`BUILD SUCCEEDED`）
2. ✅ 无编译错误
3. ✅ 警告数量 < 5 个
4. ✅ 关键功能已手动测试
5. ✅ 文档已更新

### 测试优先级

**P0 - 必须测试**:
- 编译通过
- App 启动不崩溃
- 主要功能可用

**P1 - 应该测试**:
- 边界情况
- 错误处理
- UI 交互

**P2 - 可以延后**:
- 性能优化
- UI 细节
- 动画效果

---

## 🐛 常见错误模式

### 1. 自动提交代码
- ❌ 修改完立即 `git commit && git push`
- ✅ 告知用户完成，等待"提交吧"指令

### 2. 临时文件混入仓库
- ❌ `ui-demo.html`, `*_DEMO.md`, `test-*.html`
- ✅ 只提交源代码、项目配置、必要文档

### 3. Edit 操作留下残余代码

**问题**:
```swift
// 旧代码
func old() { ... }

// 新代码（Edit 后）
func new() { ... }

// ❌ 问题：旧代码未删除，导致重复
func old() { ... }  // 残留！
```

**预防**:
- Edit 前先 Read 完整文件
- 确认 old_string 完全匹配

### 4. 类型推断失败

**问题**:
```swift
var view: some View {
    if bool {
        return Text("A")    // ❌ return 导致类型问题
    }
    Image("B")
}
```

**修复**:
```swift
@ViewBuilder
var view: some View {
    if bool {
        Text("A")  // ✅ 无 return
    } else {
        Image("B")
    }
}
```

### 5. 数据模型不兼容

**问题**: 改变 SwiftData 模型结构导致崩溃

**修复**: 总是添加迁移处理
```swift
do {
    container = try ModelContainer(...)
} catch {
    // 清理旧数据
    try? FileManager.default.removeItem(at: url)
    container = try ModelContainer(...)
}
```

---

## 📚 项目特定规则

### QuickIdea 数据模型规则

1. **标签格式**: `#字母数字下划线`
2. **标签提取**: 使用正则 `#([\\p{L}\\p{N}_]+)`
3. **App Groups**: 必须使用 `group.com.quickidea.app`
4. **数据共享**: 主 App 和 Widget 必须同步

### 文件修改检查表

修改这些文件时需要同时更新：

| 修改文件 | 必须同步更新 |
|---------|------------|
| `Idea.swift` | `QuickIdeaWidget.swift` (模型定义) |
| `IdeaStore.swift` | Widget Provider |
| 数据模型 | App + Widget 初始化 |

---

## 🚀 自动化脚本

### 快速构建测试脚本

创建 `test.sh`:
```bash
#!/bin/bash
set -e

echo "🔨 清理构建..."
xcodebuild -scheme QuickIdea -sdk iphonesimulator \
  -destination 'platform=iOS Simulator,name=iPhone 15' \
  clean

echo "🏗️  构建项目..."
xcodebuild -scheme QuickIdea -sdk iphonesimulator \
  -destination 'platform=iOS Simulator,name=iPhone 15' \
  build 2>&1 | tee build.log

echo "🔍 检查错误..."
ERRORS=$(grep -c "error:" build.log || true)
WARNINGS=$(grep -c "warning:" build.log || true)

echo ""
echo "📊 构建结果:"
echo "  错误数: $ERRORS"
echo "  警告数: $WARNINGS"

if [ $ERRORS -eq 0 ]; then
    echo "✅ 构建成功！"
    exit 0
else
    echo "❌ 构建失败，请检查错误"
    grep "error:" build.log
    exit 1
fi
```

使用方法:
```bash
chmod +x test.sh
./test.sh
```

---

## 💡 AI 开发最佳实践

### 对于 AI (Claude) 的指引

**核心原则** (按优先级):
1. ⚠️ **永远不要自动提交** - 等待"提交吧"指令
2. 🗑️ **临时文件不入库** - demo/test 文件只在本地
3. 🔨 **每次修改后必须构建测试**
4. 📦 **分阶段提交** - 不要一次改太多文件
   - 不要一次改太多文件
   - 每改一个文件就测试一次

**工作流程**:
```
修改代码 → 构建测试 → 修复错误 → 告知用户 → 等待"提交吧" → git commit
```

---

## 📖 扩展阅读

- [SwiftData 迁移指南](https://developer.apple.com/documentation/swiftdata)
- [SwiftUI ViewBuilder 详解](https://developer.apple.com/documentation/swiftui/viewbuilder)
- [Xcode 构建系统](https://developer.apple.com/documentation/xcode)

---

## 🔧 故障排查

### 问题：构建失败

1. Clean Build Folder (Cmd+Shift+K)
2. 删除 DerivedData
3. 重启 Xcode
4. 检查代码语法

### 问题：运行时崩溃

1. 查看控制台日志
2. 检查数据模型兼容性
3. 验证 App Groups 配置
4. 重新安装 App

### 问题：Widget 不显示

1. 确认 Widget Extension 已构建
2. 检查 App Groups ID
3. 验证数据共享
4. 重新添加 Widget

---

**遵循这些规则可以避免 90% 的常见错误！** ✅
